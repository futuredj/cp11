name: Build CombatPets 1.21.11

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      # Patch out the two missing "system" jar deps and the LevelledMobs compile-time listener
      - name: Patch fork for CI build
        shell: bash
        run: |
          set -e

          # Remove system-scope dependencies that require local jars
          perl -0777 -i -pe 's#<dependency>\s*<groupId>com\.magmaguy\.freeminecraftmodels</groupId>.*?</dependency>\s*##sg' Core/pom.xml
          perl -0777 -i -pe 's#<dependency>\s*<groupId>io\.github\.arcaneplugins</groupId>.*?</dependency>\s*##sg' Core/pom.xml

          # Remove LevelledMobs listener source so it doesn't need the external API at compile-time
          rm -f Core/src/main/java/su/nightexpress/combatpets/pet/listener/LevelledMobsListener.java || true
          perl -i -pe 's/^\s*import\s+su\.nightexpress\.combatpets\.pet\.listener\.LevelledMobsListener;\s*$//g' Core/src/main/java/su/nightexpress/combatpets/pet/PetManager.java
          perl -i -pe 's/^\s*this\.addListener\(new\s+LevelledMobsListener\(this\.plugin\)\);\s*$//g' Core/src/main/java/su/nightexpress/combatpets/pet/PetManager.java

      - name: Build
        run: mvn -DskipTests clean package

      - name: Upload built jar
        uses: actions/upload-artifact@v4
        with:
          name: CombatPets-jar
          path: target/*.jar
